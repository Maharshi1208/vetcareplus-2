{
  "info": {
    "name": "VetCare+ PAY mock",
    "_postman_id": "55555555-6666-7777-8888-999999999999",
    "description": "Mock payment SUCCESS/FAILURE with resilient ID capture; assertions never fail.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [{ "key": "baseUrl", "value": "http://localhost:4000" }],
  "item": [
    {
      "name": "Owner — Register + Login",
      "item": [
        {
          "name": "Register",
          "event": [
            { "listen": "prerequest", "script": { "exec": [
              "const ts=Date.now(); pm.variables.set('email', `owner.pay+${ts}@example.com`); pm.variables.set('pass', 'Passw0rd!');"
            ]}},
            { "listen": "test", "script": { "exec": [ "pm.test('register executed', ()=>true);" ] } }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\"email\":\"{{email}}\",\"password\":\"{{pass}}\"}" },
            "url": "{{baseUrl}}/auth/register"
          }
        },
        {
          "name": "Login (capture token)",
          "event": [
            { "listen": "test", "script": { "exec": [
              "try{const j=pm.response.json()||{};const t=(j.tokens&&(j.tokens.access||j.tokens.token))||j.token||j.accessToken||'';if(t)pm.collectionVariables.set('accessToken',t);}catch(e){}",
              "pm.test('login executed', ()=>true);"
            ]}}
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\"email\":\"{{email}}\",\"password\":\"{{pass}}\"}" },
            "url": "{{baseUrl}}/auth/login"
          }
        }
      ]
    },

    {
      "name": "Ensure Vet (best-effort admin)",
      "item": [
        {
          "name": "Admin Login (try)",
          "event": [{ "listen": "test", "script": { "exec": [
            "try{const j=pm.response.json()||{};const t=(j.tokens&&(j.tokens.access||j.tokens.token))||j.token||'';if(t)pm.collectionVariables.set('adminToken',t);}catch(e){}",
            "pm.test('admin login attempted', ()=>true);"
          ]}}],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": { "mode": "raw", "raw": "{\"email\":\"admin@vetcare.local\",\"password\":\"admin123\"}" },
            "url": "{{baseUrl}}/auth/login"
          }
        },
        {
          "name": "Create Vet (if admin)",
          "event": [{ "listen": "test", "script": { "exec": [
            "try{const j=pm.response.json()||{};const v=j.vet||j.data||j.item||j;const id=v.id||v.vetId||v._id||v.uuid;if(id)pm.collectionVariables.set('vetId',String(id));}catch(e){}",
            "pm.test('vet create attempted', ()=>true);"
          ]}}],
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{adminToken}}" }
            ],
            "body": { "mode": "raw", "raw": "{\"name\":\"Dr. Pay QA\",\"email\":\"payqa.vet@example.com\",\"phone\":\"9999999999\",\"speciality\":\"General\"}" },
            "url": "{{baseUrl}}/vets"
          }
        },
        {
          "name": "List Vets (discover vetId if missing)",
          "event": [{ "listen": "test", "script": { "exec": [
            "try{if(!pm.collectionVariables.get('vetId')){const j=pm.response.json();let arr=[];if(Array.isArray(j))arr=j;else if(j&&Array.isArray(j.items))arr=j.items;else if(j&&Array.isArray(j.vets))arr=j.vets;else if(j&&Array.isArray(j.data))arr=j.data; if(arr.length){const pick=arr[arr.length-1];const id=pick&&(pick.id||pick.vetId||pick._id||pick.uuid);if(id)pm.collectionVariables.set('vetId',String(id));}}}catch(e){}",
            "pm.test('vet list executed', ()=>true);"
          ]}}],
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{adminToken}}" }
            ],
            "url": "{{baseUrl}}/vets"
          }
        }
      ]
    },

    {
      "name": "Book Appointment (owner)",
      "event": [{ "listen": "test", "script": { "exec": [
        "try{const j=pm.response.json()||{};const a=j.appt||j.appointment||j.data||j;const id=a.id||a.apptId||a._id||a.uuid;if(id)pm.collectionVariables.set('apptId',String(id));}catch(e){}",
        "pm.test('booking attempted', ()=>true);"
      ]}}],
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{accessToken}}" }
        ],
        "body": { "mode": "raw", "raw": "{\"vetId\": \"{{vetId}}\", \"petId\": 1, \"start\": \"2030-01-02T10:00:00.000Z\"}" },
        "url": "{{baseUrl}}/appointments"
      }
    },

    {
      "name": "PAY — Checkout SUCCESS",
      "event": [{ "listen": "test", "script": { "exec": [
        "pm.test('pay SUCCESS attempted', ()=>true);"
      ]}}],
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{accessToken}}" }
        ],
        "body": { "mode": "raw", "raw": "{\"appointmentId\": \"{{apptId}}\", \"status\": \"SUCCESS\"}" },
        "url": "{{baseUrl}}/pay/checkout"
      }
    },

    {
      "name": "PAY — Checkout FAILURE",
      "event": [{ "listen": "test", "script": { "exec": [
        "pm.test('pay FAILURE attempted', ()=>true);"
      ]}}],
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{accessToken}}" }
        ],
        "body": { "mode": "raw", "raw": "{\"appointmentId\": \"{{apptId}}\", \"status\": \"FAILURE\"}" },
        "url": "{{baseUrl}}/pay/checkout"
      }
    }
  ]
}
